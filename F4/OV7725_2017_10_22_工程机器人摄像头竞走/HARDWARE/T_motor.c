#include <T_motor.h>
#include "sys.h"
#include "lcd.h"
#include "stm32f4xx_usart.h"
#include <string.h>

const char* p_action_list = NULL;
uint16_t* p_action_delay = NULL;

const char action_list_1[][ACTION_BYTES]=   //直立 ，结束动作：右脚在前
	{
		{"#1P1971#2P1441#3P1618#4P1650#6P1543#7P1956#8P1000#9P1324#10P1144#11P1248#12P979#13P1289#14P1216#15P941#16P1265#17P1303T2000\r\n"},
		{"#1P1971#2P1441#3P1618#4P1580#6P1543#7P1936#8P1000#9P1324#10P1053#11P1148#12P979#13P1359#14P1247#15P941#16P1265#17P1233T500\r\n"},  
		{"#1P1971#2P1441#3P1218#4P1607#6P1143#7P1926#8P1000#9P1324#10P835#11P1244#12P1301#13P1359#14P1363#15P949#16P1177#17P1223T150\r\n"},
		{"#1P1971#2P1441#3P1218#4P1663#6P1143#7P1985#8P1000#9P1324#10P1045#11P1314#12P1156#13P1282#14P1457#15P1047#16P1177#17P1306T150\r\n"},
		
		{'0'},
	};
uint16_t action_delay_1[100];

const char action_list_2[][ACTION_BYTES]=   //直走
	{
		{"#1P1971#2P1441#3P1618#4P1580#6P1543#7P1936#8P1000#9P1324#10P1053#11P1148#12P979#13P1359#14P1247#15P941#16P1265#17P1233T150\r\n"}, //右脚微抬 
		{"#1P1971#2P1441#3P1218#4P1607#6P1143#7P1926#8P1000#9P1324#10P835#11P1244#12P1301#13P1359#14P1363#15P949#16P1177#17P1223T150\r\n"},
		{"#1P1971#2P1441#3P1218#4P1663#6P1143#7P1985#8P1000#9P1324#10P1045#11P1314#12P1156#13P1282#14P1457#15P1047#16P1177#17P1306T150\r\n"},
		
		{"#1P1971#2P1441#3P1218#4P1697#6P1143#7P2026#8P1000#9P1324#10P1045#11P1314#12P1156#13P1249#14P1457#15P944#16P1172#17P1370T20\r\n"}, //左脚迈一步
		{"#1P1971#2P1441#3P1618#4P1707#6P1543#7P2046#8P1000#9P1324#10P1143#11P1248#12P979#13P1209#14P1060#15P799#16P1265#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1707#6P1942#7P2026#8P1000#9P1324#10P1210#11P1290#12P959#13P1209#14P893#15P937#16P1576#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1646#6P1942#7P1970#8P1000#9P1324#10P1427#11P1405#12P900#13P1295#14P1097#15P908#16P1378#17P1306T150\r\n"},
		
		{"#1P1971#2P1441#3P2018#4P1610#6P1942#7P1924#8P1000#9P1324#10P1427#11P1287#12P852#13P1359#14P1097#15P908#16P1378#17P1253T20\r\n"},
		
		{'0'},
	};
uint16_t action_delay_2[100];

const char action_list_3[][ACTION_BYTES]=   //左大转，半步
	{
		{"#1P1971#2P1441#3P1418#4P1697#6P1343#7P2026#8P1000#9P1324#10P1045#11P1314#12P1156#13P1249#14P1457#15P944#16P1172#17P1370T20\r\n"},
{"#1P1971#2P1441#3P1618#4P1707#6P1543#7P2046#8P1000#9P1324#10P1143#11P1248#12P979#13P1220#14P1060#15P799#16P1221#17P1490T150\r\n"},
{"#1P1971#2P1441#3P2018#4P1707#6P1942#7P2026#8P1000#9P1324#10P1210#11P1290#12P959#13P1209#14P893#15P937#16P1576#17P1370T150\r\n"},
{"#1P1971#2P1441#3P2018#4P1646#6P1942#7P1970#8P1000#9P1324#10P1427#11P1405#12P900#13P1295#14P1097#15P908#16P1378#17P1306T150\r\n"},
		
		{'0'},
	};
uint16_t action_delay_3[100];

const char action_list_4[][ACTION_BYTES]=   //右大转，半步
	{
		{"#1P1971#2P1441#3P1618#4P1580#6P1543#7P1936#8P1000#9P1324#10P1053#11P1148#12P979#13P1450#14P1247#15P941#16P1265#17P1258T150\r\n"},
{"#1P1971#2P1441#3P1218#4P1663#6P1143#7P1985#8P1000#9P1324#10P1045#11P1314#12P1156#13P1282#14P1457#15P1047#16P1177#17P1306T150\r\n"},
		
		
		{'0'},
	};
uint16_t action_delay_4[100];

const char action_list_5[][ACTION_BYTES]=   //左小转，半步
	{		
		{"#1P1971#2P1441#3P1218#4P1697#6P1143#7P2026#8P1000#9P1324#10P1045#11P1314#12P1156#13P1249#14P1457#15P944#16P1172#17P1370T20\r\n"},
		{"#1P1971#2P1441#3P1618#4P1707#6P1543#7P2046#8P1000#9P1324#10P1143#11P1248#12P979#13P1209#14P1060#15P799#16P1265#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1707#6P1942#7P2026#8P1000#9P1324#10P1210#11P1290#12P959#13P1209#14P893#15P937#16P1576#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1646#6P1942#7P1970#8P1000#9P1324#10P1427#11P1405#12P900#13P1295#14P1097#15P908#16P1378#17P1306T150\r\n"},
		
		{'0'},
	};
uint16_t action_delay_5[100];

const char action_list_6[][ACTION_BYTES]=   //右小转，半步
	{
		{"#1P1971#2P1441#3P1618#4P1580#6P1543#7P1936#8P1000#9P1324#10P1053#11P1148#12P979#13P1450#14P1247#15P941#16P1265#17P1258T150\r\n"},
		{"#1P1971#2P1441#3P1218#4P1663#6P1143#7P1985#8P1000#9P1324#10P1045#11P1314#12P1156#13P1282#14P1457#15P1047#16P1177#17P1306T150\r\n"},
		
		{'0'},
	};
uint16_t action_delay_6[100];

const char action_list_7[][ACTION_BYTES]=   //直走，左半步
	{
		{"#1P1971#2P1441#3P1218#4P1697#6P1143#7P2026#8P1000#9P1324#10P1045#11P1314#12P1156#13P1249#14P1477#15P944#16P1152#17P1370T20\r\n"},
		{"#1P1971#2P1441#3P1618#4P1707#6P1543#7P2046#8P1000#9P1324#10P1143#11P1248#12P979#13P1209#14P1129#15P799#16P1235#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1707#6P1942#7P2026#8P1000#9P1324#10P1210#11P1290#12P959#13P1209#14P902#15P937#16P1556#17P1370T150\r\n"},
		{"#1P1971#2P1441#3P2018#4P1646#6P1942#7P1970#8P1000#9P1324#10P1427#11P1405#12P900#13P1295#14P1107#15P908#16P1378#17P1306T150\r\n"},

		{'0'},
	};
uint16_t action_delay_7[100];

const char action_list_8[][ACTION_BYTES]=   //直走，右半步
	{
		{"#1P1971#2P1441#3P2018#4P1610#6P1942#7P1924#8P1000#9P1324#10P1427#11P1287#12P852#13P1359#14P1107#15P908#16P1378#17P1253T20\r\n"},
		{"#1P1971#2P1441#3P1618#4P1580#6P1543#7P1936#8P1000#9P1324#10P1053#11P1148#12P979#13P1359#14P1257#15P941#16P1265#17P1233T150\r\n"},
		{"#1P1971#2P1441#3P1218#4P1607#6P1143#7P1926#8P1000#9P1324#10P835#11P1244#12P1301#13P1359#14P1373#15P949#16P1177#17P1223T150\r\n"},
		{"#1P1971#2P1441#3P1218#4P1663#6P1143#7P1985#8P1000#9P1324#10P1045#11P1314#12P1156#13P1282#14P1467#15P1047#16P1177#17P1306T150\r\n"},

		{'0'},
	};
uint16_t action_delay_8[100];
	
void action_delay_read(uint16_t* action_delay, const char (*action_list)[ACTION_BYTES])
{
	int i=0, j=0, k=0;
	char time[5] = {0};
	while(action_list[i][0] == '#')
	{
		while(action_list[i][j] != 'T')
		{
			j++;
		}
		while(action_list[i][j] != '\r')
		{
			j++;
			time[k] = action_list[i][j];
			k++;
		}
		time[k+1] = '\0';
		action_delay[i] = atoi(time)*10;
		i++;
		j=0;
		k=0;
	}
}

void action_set(uint16_t* action_delay, const char (*action_list)[ACTION_BYTES])
{
	p_action_delay = action_delay;
	p_action_list = action_list[0];
	while(p_action_list != NULL);
}

void TIM3_Int_Init(u16 arr,u16 psc)
{
       TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
       NVIC_InitTypeDef NVIC_InitStructure;
      
       RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3,ENABLE); //①使能TIM3时钟
      
			 TIM_TimeBaseInitStructure.TIM_Period = arr; //自动重装载值
       TIM_TimeBaseInitStructure.TIM_Prescaler=psc;  //定时器分频
       TIM_TimeBaseInitStructure.TIM_CounterMode=TIM_CounterMode_Up; //向上计数模式
       TIM_TimeBaseInitStructure.TIM_ClockDivision=TIM_CKD_DIV1;
      
       TIM_TimeBaseInit(TIM3,&TIM_TimeBaseInitStructure);// ②初始化定时器TIM3
      
       TIM_ITConfig(TIM3,TIM_IT_Update,ENABLE); //③允许定时器3更新中断
      
       NVIC_InitStructure.NVIC_IRQChannel=TIM3_IRQn; //定时器3中断
       NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=0x00; //抢占优先级1
       NVIC_InitStructure.NVIC_IRQChannelSubPriority=0x00; //响应优先级3
       NVIC_InitStructure.NVIC_IRQChannelCmd=ENABLE;
       NVIC_Init(&NVIC_InitStructure);// ④初始化NVIC
 
			TIM_Cmd(TIM3,ENABLE); //⑤使能定时器3
}


void TIM3_IRQHandler(void)
{
	static uint8_t j=0;
	static uint16_t delay_count=0;
	char word_sent;      //被发送字节
	
	if(TIM_GetITStatus(TIM3,TIM_IT_Update)==SET) //溢出中断
  {
		if(p_action_list != NULL)
		{
			if(delay_count == 0)
			{
				word_sent = *(p_action_list+j); 
				j++;
				if(word_sent == '\n')
				{
					delay_count = 1; //启动延时
					j = 0;
				}
//				while((USART1->SR&0X40)==0);
				USART1->DR = (u8)word_sent;
			}
			else if(delay_count < *(p_action_delay))
			{
				delay_count++;
			}
			else //延时结束
			{
				delay_count = 0;
				p_action_list += ACTION_BYTES;   //如果上一次执行了最后一行
				if(*p_action_list == '0')
					p_action_list = NULL;
				p_action_delay++;
			}
		}
	}
	TIM_ClearITPendingBit(TIM3,TIM_IT_Update);  //清除中断标志位
}







